<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Octoscope Report</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-light bg-primary shadow h-100">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 text-light">Octoscope Report</span>
      </div>
    </nav>

    <div class="container pt-2">
      <div id="loading" class="row p-3">
        <div class="col text-center">
          Loading...
        </div>
      </div>

      <div id="content" style="display: none;">
        <div class="row justify-content-between py-2">
          <div class="card border-primary shadow h-100" style="width: 18rem">
            <div class="card-body">
              <p class="card-title text-secondary">Total Actual Duration</p>
              <h5 id="total-duration" class="card-text">Loading...</h5>
            </div>
          </div>

          <div class="card border-primary shadow h-100" style="width: 18rem">
            <div class="card-body">
              <p class="card-title text-secondary">Total Billable Duration</p>
              <h5 id="total-billable-duration" class="card-text">Loading...</h5>
            </div>
          </div>

          <div class="card border-primary shadow h-100" style="width: 18rem">
            <div class="card-body">
              <p class="card-title text-secondary">Total Billable in USD</p>
              <h5 id="total-billable-usd" class="card-text">Loading...</h5>
            </div>
          </div>
        </div>

        <div class="row p-2">
          <div class="col">
            <canvas id="chart"></canvas>
          </div>
        </div>

        <div class="row p-2">
          <div class="table-responsive">
            <table id="workflow-summary" class="table"></table>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Stats util functions
      const sum = arr => arr.reduce((acc, curr) => acc + curr.run_duration, 0);
      const mean = arr => (sum(arr) / arr.length).toFixed(3);
      const min = sortedArr => sortedArr[0].run_duration;
      const max = sortedArr => sortedArr.at(-1).run_duration;

      // Data loading functions
      async function loadSummary() {
        try {
          const response = await fetch('data/summary.json');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          return data.totals;
        } catch (error) {
          const loading = document.getElementById('loading');
          loading.innerHTML = `
            <div class="col text-center alert alert-danger">
              <h4>Error: Could not load data</h4>
              <p>Please make sure you're running the Python HTTP server first.</p>
              <div class="bg-light p-3 mt-3 rounded">
                <p class="mb-2">Run these commands in your terminal:</p>
                <code>cd reports</code><br>
                <code>python3 -m http.server 8000</code>
              </div>
              <p class="mt-3">Then refresh this page.</p>
            </div>`;
          throw error;
        }
      }

      async function loadJobs() {
        const response = await fetch('data/jobs.json');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      }

      // UI update functions
      function updateTotals(totals) {
        document.getElementById('total-duration').textContent = totals.job_duration / 1000000000;
        document.getElementById('total-billable-duration').textContent = totals.rounded_up_job_duration / 1000000000;
        document.getElementById('total-billable-usd').textContent = totals.billable_in_usd.toFixed(3);
      }

      function processJobs(jobs) {
        const transformedJobs = jobs.map(job => ({
          workflow_name: job.workflow?.name || 'Unknown Workflow',
          workflow_run_id: job.workflow_run?.id || 0,
          created_at: new Date(job.workflow_run?.created_at || new Date()),
          job_duration: Number(job.job_duration || 0),
          rounded_up_job_duration: Number(job.rounded_up_job_duration || 0),
          billable_in_usd: Number(job.billable_in_usd || 0)
        }));

        const summed = transformedJobs.reduce((acc, job) => {
          const workflowName = job.workflow_name;
          if (!acc[workflowName]) {
            acc[workflowName] = {};
          }

          const runId = String(job.workflow_run_id);
          if (!acc[workflowName][runId]) {
            acc[workflowName][runId] = {
              run_duration: 0,
              rounded_up_duration: 0,
              billable_in_usd: 0,
              created_at: job.created_at
            };
          }

          acc[workflowName][runId].run_duration += job.job_duration / 1000000000;
          acc[workflowName][runId].rounded_up_duration += job.rounded_up_job_duration / 1000000000;
          acc[workflowName][runId].billable_in_usd += job.billable_in_usd;
          return acc;
        }, {});

        updateChart(summed);
        updateTable(summed);
      }

      function updateChart(summed) {
        const chart = document.getElementById('chart');
        const durations = Object.entries(summed).map(([name, runs]) => ({
          label: name + ' Actual Duration',
          data: Object.entries(runs).map(([runId, run]) => ({
            x: run.created_at,
            y: run.run_duration
          })),
          borderWidth: 1
        }));

        const billable_durations = Object.entries(summed).map(([name, runs]) => ({
          label: name + ' Billable Duration',
          data: Object.entries(runs).map(([runId, run]) => ({
            x: run.created_at,
            y: run.rounded_up_duration
          })),
          borderWidth: 1,
          fill: '-1'
        }));

        const datasets = durations.concat(billable_durations);
        datasets.sort((a, b) => a.label < b.label ? -1 : a.label > b.label ? 1 : 0);

        if (!chart.chart) {
          chart.chart = new Chart(chart, {
            type: 'line',
            data: { datasets },
            options: {
              plugins: {
                legend: { display: true }
              },
              scales: {
                x: {
                  type: "time",
                  display: true,
                  title: {
                    display: true,
                    text: 'Datetime'
                  }
                },
                y: {
                  title: {
                    display: true,
                    text: 'Duration (sec)'
                  }
                }
              }
            }
          });
        } else {
          chart.chart.data.datasets = datasets;
          chart.chart.update();
        }
      }

      function updateTable(summed) {
        const table = document.getElementById('workflow-summary');
        table.innerHTML = '';

        const thead = document.createElement('thead');
        table.appendChild(thead);
        const tr = document.createElement('tr');
        thead.appendChild(tr);
        
        const headers = ['workflow', 'no. of runs', 'min', 'mean', 'max'];
        headers.forEach(header => {
          const th = document.createElement('th');
          th.textContent = header;
          th.classList.add("table-primary");
          tr.appendChild(th);
        });
        
        const tbody = document.createElement('tbody');
        table.appendChild(tbody);
        
        for (const [workflowName, runs] of Object.entries(summed)) {
          const tr = document.createElement('tr');
          tbody.appendChild(tr);
          
          // workflow name
          let td = document.createElement('td');
          td.textContent = workflowName;
          tr.appendChild(td);
          
          const runsArray = Object.values(runs).sort((a, b) => a.run_duration - b.run_duration);
          
          // no. of runs
          td = document.createElement('td');
          td.textContent = runsArray.length;
          tr.appendChild(td);

          // min
          td = document.createElement('td');
          td.textContent = min(runsArray);
          tr.appendChild(td);

          // mean
          td = document.createElement('td');
          td.textContent = mean(runsArray);
          tr.appendChild(td);
  
          // max
          td = document.createElement('td');
          td.textContent = max(runsArray);
          tr.appendChild(td);
        }
      }

      // Initialization
      async function init() {
        try {
          const [totals, jobs] = await Promise.all([loadSummary(), loadJobs()]);
          updateTotals(totals);
          processJobs(jobs);
          document.getElementById('loading').style.display = 'none';
          document.getElementById('content').style.display = 'block';
        } catch (error) {
          console.error('Failed to initialize:', error);
        }
      }

      init();
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
