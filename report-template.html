<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Octoscope Report</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-light bg-primary shadow h-100">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 text-light">Octoscope Report</span>
      </div>
    </nav>
    <div class="container pt-2">
      <div class="row justify-content-between py-2">
        <div class="card border-primary shadow h-100" style="width: 18rem">
          <div class="card-body">
            <p class="card-title text-secondary">Total Actual Duration</p>
            <h5 class="card-text">{{.Totals.JobDuration}}</h5>
          </div>
        </div>

        <div class="card border-primary shadow h-100" style="width: 18rem">
          <div class="card-body">
            <p class="card-title text-secondary">Total Billable Duration</p>
            <h5 class="card-text">{{.Totals.RoundedUpJobDuration}}</h5>
          </div>
        </div>

        <div class="card border-primary shadow h-100" style="width: 18rem">
          <div class="card-body">
            <p class="card-title text-secondary">Total Billabe in USD</p>
            <h5 class="card-text">{{.Totals.BillableInUSD}}</h5>
          </div>
        </div>
      </div>

      <div id="loading" class="row p-3">
        <div class="col text-center">
          Loading...
        </div>
      </div>

      <div class="row p-2">
        <div class="col">
          <canvas id="chart"></canvas>
        </div>
      </div>

      <div class="row p-2">
        <div class="table-responsive">
          <table id="workflow-summary" class="table"></table>
        </div>
      </div>
    </div>
    <script>
      const loading = document.getElementById('loading');
      loading.style.display = 'none';

      const jobs = {{.Jobs}}

      const summed = jobs.reduce((acc, job) => {
        if (!acc[job.workflow.name]) {
          acc[job.workflow.name] = {}
        }

        if (!acc[job.workflow.name][job.workflow_run.id]) {
          acc[job.workflow.name][job.workflow_run.id] = {
            run_duration: 0,
            rounded_up_duration: 0,
            billable_in_usd: 0
          }
        }

        acc[job.workflow.name][job.workflow_run.id].run_duration += job.job_duration/1000000000
        acc[job.workflow.name][job.workflow_run.id].rounded_up_duration += job.rounded_up_job_duration/1000000000
        acc[job.workflow.name][job.workflow_run.id].billable_in_usd += job.billable_in_usd ? job.billable_in_usd : 0
        acc[job.workflow.name][job.workflow_run.id].created_at = job.workflow_run.created_at
        return acc
      }
      , {})


      const chart = document.getElementById('chart');
      const durations = Object.entries(summed).map(([name, runs]) => ({label: name + ' Actual Duration', data: Object.entries(runs).map(([runId, run]) => ({x: run.created_at, y: run.run_duration})), borderWidth: 1}))
      const billabeDurations = Object.entries(summed).map(([name, runs]) => ({label: name + ' Billable Duration', data: Object.entries(runs).map(([runId, run]) => ({x: run.created_at, y: run.rounded_up_duration})), borderWidth: 1, fill: '-1'}))
      const datasets = durations.concat(billabeDurations)
      datasets.sort((a,b)=> {
        if (a.label < b.label) {
          return -1;
        }
        if (a.label > b.label) {
          return 1;
        }
        return 0;
      })
      
      new Chart(chart, {
        type: 'line',
        data: {
          datasets
        },
        options: {
          plugins: {
            legend: {
              display: true
            }
          },
          scales: {
            x: {
              type: "time",
              display: true,
              title: {
                display: true,
                text: 'Datetime'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Duration (sec)'
              }
            }
          }
        }
      });
      
      // stats util functions:
      const sum = arr => arr.reduce((acc, curr) => acc + curr.run_duration, 0);
      const mean = arr => (sum(arr) / arr.length).toFixed(3);
      const min = sortedArr => sortedArr[0].run_duration
      const max = sortedArr => sortedArr.at(-1).run_duration

      function genereateWorkflowSummary() {
        const table = document.querySelector('#workflow-summary')
        if (!summed || Object.keys(summed).length == 0) {
          console.info('No data, cannot generate table.')
          return
        }

        let thead = document.createElement('thead')
        table.appendChild(thead)
        let tr = document.createElement('tr')
        thead.appendChild(tr)
        const headers = ['workflow', 'no. of runs', 'min', 'mean', 'max']
        for (let header of headers) {
          let th = document.createElement('th')
          th.innerText = header
          th.classList.add("table-primary")
          tr.appendChild(th)
        }
        
        let tbody = document.createElement('tbody')
        table.appendChild(tbody)
        for (let [workflowName, runs] of Object.entries(summed)) {
          let tr = document.createElement('tr')
          tbody.appendChild(tr)
          
          // workflow name
          td = document.createElement('td')
          td.innerText = workflowName
          tr.appendChild(td)
          
          const runsArray = Object.values(runs).sort((a, b) => a.run_duration - b.run_duration)
          
          // no. of runs
          td = document.createElement('td')
          td.innerText = runsArray.length
          tr.appendChild(td)

          // min
          td = document.createElement('td')
          td.innerText = min(runsArray)
          tr.appendChild(td)

          // mean
          td = document.createElement('td')
          td.innerText = mean(runsArray)
          tr.appendChild(td)
  
          // max
          td = document.createElement('td')
          td.innerText = max(runsArray)
          tr.appendChild(td)
        }
      }
      genereateWorkflowSummary()
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
